name: Propose README Snapshot Updates

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch: {}

# No permissions block needed here because we are using a PAT
# which has its own permissions.

jobs:
  propose-sync:
    runs-on: ubuntu-latest # Switched to ubuntu for better cross-compat
    steps:
      # Step 1: Checkout the source of the script and content (this repo)
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          path: source-repo

      # Step 2: Checkout the target repo where the PR will be made
      - name: Checkout Target Repo
        uses: actions/checkout@v4
        with:
          repository: kalvinparker/kalvinparker # Explicitly check out the target
          path: target-repo
          token: ${{ secrets.AUTOMATION_PAT }} # Use PAT to checkout private/other repo

      # Step 3: Run the import script, making sure its output goes to the target directory
      - name: Run import script
        id: run_import
        shell: pwsh
        continue-on-error: true
        run: |
          # The script is in source-repo, but its output must go to target-repo
          try {
            ./source-repo/scripts/import_readmes.ps1 -OutputPath ./target-repo/docs
            Write-Host "Script completed. LASTEXITCODE: $LASTEXITCODE"
          } catch {
            Write-Host "Script threw an exception: $_"
          }
          # Force success so downstream steps run and we can observe PR creation or artifact upload
          Exit 0

      # Diagnostic step: list checkouts and confirm PAT presence (helps triage failures)
      - name: "Debug: list workspace and tokens"
        if: ${{ steps.run_import.outcome == 'failure' }}
        shell: pwsh
        run: |
          Write-Host "== source-repo contents =="
          Get-ChildItem -Path source-repo -Recurse -Force -Depth 2 | Select-Object FullName -First 200 | ForEach-Object { Write-Host $_.FullName }
          Write-Host "== target-repo contents =="
          Get-ChildItem -Path target-repo -Recurse -Force -Depth 2 | Select-Object FullName -First 200 | ForEach-Object { Write-Host $_.FullName }
          if ($env:AUTOMATION_PAT) { Write-Host 'AUTOMATION_PAT is set' } else { Write-Host 'AUTOMATION_PAT is NOT set' }

      - name: Check PAT presence
        id: pat_check
        run: |
          if [ -n "${{ secrets.AUTOMATION_PAT }}" ]; then
            echo "pat_present=true" >> $GITHUB_OUTPUT
          else
            echo "pat_present=false" >> $GITHUB_OUTPUT
          fi

      # Step 4: Create the pull request against the target repo
      - name: Create Pull Request
        if: ${{ steps.pat_check.outputs.pat_present == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.AUTOMATION_PAT }}
          # IMPORTANT: Point the action to the directory of the target repo
          path: target-repo
          commit-message: "docs: refresh README snapshots"
          title: "Automated README Snapshot Update"
          body: |
            This PR was automatically generated by a scheduled workflow to refresh the README snapshots.
            
            Source workflow is in the `profile-template` repository.
          branch: "chore/auto-readme-sync"
          delete-branch: true

      # If the automation PAT is not available (for example in forks or when the secret is missing),
      # upload the generated docs so they can be inspected manually.
      - name: "Upload README snapshots (no PAT available)"
        if: ${{ steps.pat_check.outputs.pat_present == 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: readme-snapshots
          path: target-repo/docs