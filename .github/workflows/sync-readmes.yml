name: Propose README Snapshot Updates

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch: {}

# No permissions block needed here because we are using a PAT
# which has its own permissions.

jobs:
  propose-sync:
    runs-on: ubuntu-latest # Switched to ubuntu for better cross-compat
    steps:
      # Step 1: Checkout the source of the script and content (this repo)
      - name: Checkout Source Repo (with PAT)
        if: ${{ secrets.AUTOMATION_PAT }}
        uses: actions/checkout@v4
        with:
          path: source-repo
          token: ${{ secrets.AUTOMATION_PAT }}

      - name: Checkout Source Repo (no PAT)
        if: ${{ !secrets.AUTOMATION_PAT }}
        uses: actions/checkout@v4
        with:
          path: source-repo

      # Step 2: Checkout the target repo where the PR will be made
      - name: Checkout Target Repo
        uses: actions/checkout@v4
        with:
          repository: kalvinparker/kalvinparker # Explicitly check out the target
          path: target-repo
          token: ${{ secrets.AUTOMATION_PAT }} # Use PAT to checkout private/other repo

      # Step 3: Run the import script, making sure its output goes to the target directory
      - name: Run import script
        id: run_import
        shell: pwsh
        continue-on-error: true
        run: |
          # The script is in source-repo, but its output must go to target-repo
          try {
            ./source-repo/scripts/import_readmes.ps1 -OutputPath ./target-repo/docs
            Write-Host "Script completed. LASTEXITCODE: $LASTEXITCODE"
          } catch {
            Write-Host "Script threw an exception: $_"
          }
          # Force success so downstream steps run and we can observe PR creation or artifact upload
          Exit 0

      # Diagnostic step: list checkouts and confirm PAT presence (helps triage failures)
      - name: "Debug: list workspace and tokens"
        if: ${{ steps.run_import.outcome == 'failure' }}
        shell: pwsh
        run: |
          Write-Host "== source-repo contents =="
          Get-ChildItem -Path source-repo -Recurse -Force -Depth 2 | Select-Object FullName -First 200 | ForEach-Object { Write-Host $_.FullName }
          Write-Host "== target-repo contents =="
          Get-ChildItem -Path target-repo -Recurse -Force -Depth 2 | Select-Object FullName -First 200 | ForEach-Object { Write-Host $_.FullName }
          if ($env:AUTOMATION_PAT) { Write-Host 'AUTOMATION_PAT is set' } else { Write-Host 'AUTOMATION_PAT is NOT set' }

      - name: Check PAT presence
        id: pat_check
        run: |
          if [ -n "${{ secrets.AUTOMATION_PAT }}" ]; then
            echo "pat_present=true" >> $GITHUB_OUTPUT
          else
            echo "pat_present=false" >> $GITHUB_OUTPUT
          fi

      # If the PAT is present, ensure there is at least one file change to commit.
      # This avoids the create-pull-request action skipping branch creation when
      # the import script produced no diffs (e.g. only listing files were written).
      - name: Ensure commitable change
        if: ${{ steps.pat_check.outputs.pat_present == 'true' }}
        run: |
          echo "Checking for changes under target-repo/docs..."
          # Operate inside the target-repo checkout so git status sees the working tree
          cd target-repo
          mkdir -p docs
          # See if any tracked/staged/unstaged changes exist under the docs path
          if [ -n "$(git status --porcelain docs)" ]; then
            echo "Changes detected in docs; no forced change necessary."
          else
            echo "No changes detected in docs; creating timestamp to force PR."
            date -u +"%Y-%m-%dT%H:%M:%SZ" > docs/.auto_readme_sync
            echo "Wrote docs/.auto_readme_sync"
          fi

      # Step 4: Create the pull request against the target repo
      - name: Create Pull Request
        if: ${{ steps.pat_check.outputs.pat_present == 'true' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.AUTOMATION_PAT }}
          # IMPORTANT: Point the action to the directory of the target repo
          path: target-repo
          commit-message: "docs: refresh README snapshots"
          title: "Automated README Snapshot Update"
          body: |
            This PR was automatically generated by a scheduled workflow to refresh the README snapshots.
            
            Source workflow is in the `profile-template` repository.
          branch: "chore/auto-readme-sync"
          delete-branch: true

      # After the PR is created, remove the auto timestamp file so it does not remain in the PR.
      - name: Remove timestamp from PR branch
        if: ${{ steps.pat_check.outputs.pat_present == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Attempting to remove target-repo/docs/.auto_readme_sync from PR branch chore/auto-readme-sync if present"
          cd target-repo
          # Configure credentials for pushing with the PAT used earlier
          git config --local http.https://github.com/.extraheader "AUTHORIZATION: basic ${{ secrets.AUTOMATION_PAT }}"
          # Ensure pushes use the PAT (avoid interactive prompts)
          git remote set-url origin "https://x-access-token:${{ secrets.AUTOMATION_PAT }}@github.com/${{ github.repository }}"
          # Fetch the branch created by the create-pull-request action if it exists
          if git ls-remote --exit-code --heads origin chore/auto-readme-sync >/dev/null 2>&1; then
            git fetch origin chore/auto-readme-sync:chore/auto-readme-sync
            git checkout chore/auto-readme-sync
          else
            echo "Branch chore/auto-readme-sync does not exist on origin; nothing to remove"
            exit 0
          fi

          if [ -f docs/.auto_readme_sync ]; then
            git rm -f docs/.auto_readme_sync || true
            if git commit -m "ci: remove auto-generated timestamp file" >/dev/null 2>&1; then
              echo "Committed removal; pushing to origin chore/auto-readme-sync"
              git push origin chore/auto-readme-sync
            else
              echo "No commit was created (no changes)"
            fi
          else
            echo "No timestamp file found in docs; nothing to remove"
          fi

      # If the automation PAT is not available (for example in forks or when the secret is missing),
      # upload the generated docs so they can be inspected manually.
      - name: "Upload README snapshots (no PAT available)"
        if: ${{ steps.pat_check.outputs.pat_present == 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: readme-snapshots
          path: target-repo/docs