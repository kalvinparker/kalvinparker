name: Sync Security Policy

on:
  push:
    branches:
      - main
    paths:
      - 'SECURITY.md'

jobs:
  sync-policy-to-repos:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ['kalvinparker/ELK-Stack', 'kalvinparker/secure-gemini']

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Source Repo (`kalvinparker`)
        uses: actions/checkout@v4
        with:
          path: 'source'

      - name: Checkout Target Repo (${{ matrix.repo }})
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          path: 'target'
          # Use a PAT here if the GITHUB_TOKEN lacks cross-repo permissions
          # token: ${{ secrets.POLICY_SYNC_PAT }}

      - name: Compare and Sync File
        id: compare
        run: |
          SOURCE_FILE="source/SECURITY.md"
          TARGET_FILE="target/SECURITY.md"
          if ! cmp -s "$SOURCE_FILE" "$TARGET_FILE"; then
            echo "Policy files differ. Preparing update..."
            cp $SOURCE_FILE $TARGET_FILE
            echo "needs_pr=true" >> $GITHUB_OUTPUT
          else
            echo "Policy is already in sync."
            echo "needs_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request if Needed
        if: ${{ steps.compare.outputs.needs_pr == 'true' }}
        uses: peter-evans/create-pull-request@v7
        with:
          path: 'target'
          commit-message: "chore(governance): Sync SECURITY.md from source"
          title: "Update SECURITY.md Policy"
          body: |
            This PR was automatically generated to sync the `SECURITY.md` file with the central policy.

            Please review and merge.
          branch: "governance/sync-security-policy"
          delete-branch: true

