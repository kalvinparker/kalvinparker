name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then echo "README.md missing"; exit 1; fi
      - name: Lint Markdown (basic)
        run: |
          # simple check for unclosed HTML comment markers used by templates
          if grep -R "<!-- START_" -n README.md; then echo "Template markers present"; fi

  set-topics:
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push'
    steps:
      - name: Set repository topics (optional)
        env:
          REPO: ${{ github.repository }}
          TOPICS: "profile,devsecops,devops,iac,ci-cd"
          GITHUB_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          if [ -z "$GITHUB_TOKEN" ]; then echo "No REPO_PAT secret found; skipping topics update"; exit 0; fi
          echo "Setting topics: $TOPICS for $REPO"
          curl -s -X PUT -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/topics -d "{\"names\": [$(echo $TOPICS | sed 's/,/", \"/g' | sed 's/^/\"/' | sed 's/$/\"/')] }"
