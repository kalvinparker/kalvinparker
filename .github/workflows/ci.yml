name: CI

# Restrict default token permissions for security. The workflow will use the
# repository secret REPO_PAT only for the topics update step if provided.
permissions:
  contents: read

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then echo "README.md missing"; exit 1; fi
      - name: Lint Markdown (basic)
        run: |
          # simple check for unclosed HTML comment markers used by templates
          if grep -R "<!-- START_" -n README.md; then echo "Template markers present"; fi

  set-topics:
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push'
    permissions:
      contents: read
    steps:
      - name: Set repository topics (optional)
        env:
          REPO: ${{ github.repository }}
          TOPICS: "profile,devsecops,devops,iac,ci-cd"
          REPO_PAT: ${{ secrets.REPO_PAT }}
        run: |
          if [ -z "$REPO_PAT" ]; then echo "No REPO_PAT secret found; skipping topics update"; exit 0; fi
          echo "Setting topics: $TOPICS for $REPO"
          # Build JSON payload safely
          TOPIC_JSON=$(printf '%s' "$TOPICS" | awk -v q='"' -v OFS=, '{ n=split($0,a,","); printf("\"%s\"", a[1]); for(i=2;i<=n;i++) printf(", \"%s\"", a[i]) }')
          PAYLOAD="{\"names\": [${TOPIC_JSON}] }"
          curl -s -X PUT -H "Authorization: token $REPO_PAT" -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/topics -d "$PAYLOAD"
