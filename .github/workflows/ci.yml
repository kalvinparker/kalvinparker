name: CI

# Restrict default token permissions for security. The workflow will use the
# repository secret REPO_PAT only for the topics update step if provided.
permissions:
  contents: read

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then echo "README.md missing"; exit 1; fi
      - name: Lint Markdown (basic)
        run: |
          # simple check for unclosed HTML comment markers used by templates
          if grep -R "<!-- START_" -n README.md; then echo "Template markers present"; fi

  set-topics:
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push'
    permissions:
      contents: read
      issues: write
    steps:
      - name: Set repository topics (optional)
        uses: actions/github-script@v6
        with:
          script: |
            const topics = (process.env.TOPICS || '').split(',').map(t => t.trim()).filter(Boolean)
            if (topics.length === 0) {
              core.info('No topics provided; skipping')
              return
            }
            core.info(`Setting topics: ${topics.join(', ')}`)
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/')
            // Use the provided PAT if present, else the GITHUB_TOKEN (read-only by default)
            const token = process.env.REPO_PAT || process.env.GITHUB_TOKEN
            if (!token) {
              core.info('No token available; skipping')
              return
            }
            const octokit = github.getOctokit(token)
            await octokit.rest.repos.replaceAllTopics({ owner, repo, names: topics })
        env:
          TOPICS: "profile,devsecops,devops,iac,ci-cd"
          REPO_PAT: ${{ secrets.REPO_PAT }}
